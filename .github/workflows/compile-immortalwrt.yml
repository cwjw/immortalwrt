# ImmortalWrt MT7620A(SL-IR4) 云编译脚本 - 4线程+百分比进度版
# 核心特性：4线程编译+实时百分比进度+国外源优先+智能容错+中文标题+Ubuntu22.04适配
name: 编译ImmortalWrt固件 for MT7620A-SL-IR4 (4线程 | 百分比进度)

on:
  workflow_dispatch:
  push:
    branches: [ master ]
    paths:
      - 'configs/ramips/mt7620/config-mt7620a-sl-ir4'

jobs:
  compile_firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 120  # 4线程编译提速，缩短全局超时
    defaults:
      run:
        shell: bash
        working-directory: .

    steps:
      # 步骤1：安装编译依赖（优化内存配置，适配4线程）
      - name: 步骤1/9 - 安装编译依赖（适配4线程）
        run: |
          echo -e "\033[32m[开始] 安装Ubuntu22.04编译依赖（优化内存配置）...\033[0m"
          sudo sed -i 's/ports.ubuntu.com/archive.ubuntu.com/g' /etc/apt/sources.list
          sudo apt update -y && sudo apt full-upgrade -y -q --fix-missing
          # 安装内存优化工具，适配4线程编译
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          curl subversion libxml2 libxml2-utils xsltproc qemu-utils upx-ucl autoconf automake \
          libtool autopoint make libncursesw5-dev libelf-dev swig libpcre3-dev pkg-config patch \
          qemu-system-arm qemu-system-mips tree libssl3 libstdc++6 ccache  # 新增ccache加速编译
          # 优化系统内存限制，避免4线程溢出
          sudo sysctl -w vm.swappiness=10
          sudo fallocate -l 4G /swapfile && sudo chmod 600 /swapfile && sudo mkswap /swapfile && sudo swapon /swapfile
          sudo apt autoremove -y && sudo apt clean -y && sudo rm -rf /var/lib/apt/lists/*
          echo -e "\033[32m[完成] 依赖安装+内存优化成功！\033[0m"
        timeout-minutes: 10
        continue-on-error: true

      # 步骤2：拉取ImmortalWrt源码（GitHub国外源）
      - name: 步骤2/9 - 拉取ImmortalWrt源码（GitHub源）
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: master
          fetch-depth: 0
          persist-credentials: false
        timeout-minutes: 10
        continue-on-error: true

      # 步骤3：初始化依赖源（优先GitHub）
      - name: 步骤3/9 - 初始化依赖源（优先GitHub）
        run: |
          echo -e "\033[32m[开始] 初始化GitHub依赖源...\033[0m"
          cp feeds.conf.default feeds.conf.default.bak
          echo "src-git-full packages https://github.com/immortalwrt/packages.git;openwrt-23.05" > feeds.conf.default
          echo "src-git-full luci https://github.com/immortalwrt/luci.git;openwrt-23.05" >> feeds.conf.default
          echo "src-git-full routing https://github.com/immortalwrt/routing.git;openwrt-23.05" >> feeds.conf.default
          echo "src-git-full telephony https://github.com/immortalwrt/telephony.git;openwrt-23.05" >> feeds.conf.default
          ./scripts/feeds update -a 2>&1 | tee ./feeds_update.log
          ./scripts/feeds install -a 2>&1 | tee ./feeds_install.log
          echo -e "\033[32m[完成] 依赖源初始化成功！\033[0m"
        timeout-minutes: 8
        continue-on-error: true

      # 步骤4：加载SL-IR4专属配置
      - name: 步骤4/9 - 加载SL-IR4专属配置
        run: |
          echo -e "\033[32m[开始] 加载MT7620A-SL-IR4配置...\033[0m"
          [ -f .config ] && { mv .config .config.bak; echo "[提示] 备份原有配置"; }
          cp configs/ramips/mt7620/config-mt7620a-sl-ir4 .config
          make defconfig V=s 2>&1 | tee ./defconfig.log
          echo -e "\033[32m[完成] 配置加载成功！\033[0m"
        timeout-minutes: 6
        continue-on-error: true

      # 步骤5：下载依赖包（智能容错+进度提示）
      - name: 步骤5/9 - 下载编译依赖包（智能容错）
        run: |
          echo -e "\033[32m[开始] 下载依赖包（4线程，智能容错）...\033[0m"
          retry_count=0
          switch_source_flag=0
          max_retry=12
          switch_retry=3
          
          switch_source() {
            echo -e "\033[33m[提示] 重试${retry_count}次，更换GitHub备用源...\033[0m"
            cp feeds.conf.default.bak feeds.conf.default
            echo "src-git-full packages https://github.com/openwrt/packages.git;openwrt-23.05" > feeds.conf.default
            echo "src-git-full luci https://github.com/openwrt/luci.git;openwrt-23.05" >> feeds.conf.default
            echo "src-git-full routing https://github.com/openwrt/routing.git;openwrt-23.05" >> feeds.conf.default
            echo "src-git-full telephony https://github.com/openwrt/telephony.git;openwrt-23.05" >> feeds.conf.default
            ./scripts/feeds update -a 2>&1 | tee ./feeds_switch.log
            switch_source_flag=1
          }
          
          while [ $retry_count -lt $max_retry ]; do
            echo -e "\033[33m[重试] 第$((retry_count+1))/$max_retry 次下载依赖...\033[0m"
            make -j4 download V=s 2>&1 | tee ./download_${retry_count}.log  # 4线程下载
            if [ $? -eq 0 ]; then
              echo -e "\033[32m[完成] 依赖包下载成功！\033[0m"
              break
            else
              echo -e "\033[31m[错误] 第$((retry_count+1))次下载失败\033[0m"
              retry_count=$((retry_count+1))
              if [ $retry_count -eq $switch_retry ] && [ $switch_source_flag -eq 0 ]; then
                switch_source
              fi
              if [ $retry_count -eq $max_retry ]; then
                echo -e "\033[31m[警告] 重试12次失败，跳过下载！\033[0m"
                echo "依赖下载超时12次" > ./download_error.log
                break
              fi
              sleep 3
            fi
          done
        timeout-minutes: 40
        continue-on-error: true

      # 步骤6：编译固件（4线程+实时百分比进度）
      - name: 步骤6/9 - 编译固件（4线程+百分比进度）
        run: |
          echo -e "\033[31m[重要提示] 开始4线程编译固件，总耗时约40-60分钟，以下为实时进度：\033[0m"
          # 生成编译任务总数，用于计算百分比
          make -j4 -n V=s 2>/dev/null | grep -E '^make\[|^gcc|^g\+\+|^libtool' | wc -l > ./total_tasks.log
          total_tasks=$(cat ./total_tasks.log)
          echo -e "\033[33m[编译信息] 总编译任务数：$total_tasks 个\033[0m"
          
          # 4线程编译+实时进度百分比
          make -j4 V=s 2>&1 | tee ./compile_raw.log | awk -v total="$total_tasks" '
          BEGIN {
            completed = 0;
            last_percent = 0;
          }
          # 匹配编译任务行（gcc/g++/libtool）
          /^gcc |^g\+\+ |^libtool: compile:/ {
            completed++;
            percent = int((completed / total) * 100);
            # 每完成1%输出一次进度，避免日志刷屏
            if (percent > last_percent) {
              printf "\033[32m[编译进度] %d/%d (%d%%) 完成\033[0m\r", completed, total, percent;
              last_percent = percent;
              # 关键阶段单独提示
              if (percent == 20) print "\n\033[33m[阶段提示] 正在编译libressl加密库（约占20%任务）\033[0m";
              if (percent == 50) print "\n\033[33m[阶段提示] 正在编译内核模块（约占50%任务）\033[0m";
              if (percent == 80) print "\n\033[33m[阶段提示] 正在编译LuCI和4G模块（约占80%任务）\033[0m";
            }
          }
          # 编译完成提示
          END {
            print "\n\033[32m[编译完成] 总完成任务数：" completed "/" total " (100%)\033[0m";
          }'
          
          # 检查编译状态
          if [ $? -ne 0 ]; then
            echo -e "\033[31m[错误] 编译失败，日志已保存为compile_raw.log\033[0m"
            touch ./compile_error.flag
          else
            echo -e "\033[32m[完成] 4线程编译固件成功！\033[0m"
          fi
        timeout-minutes: 90
        continue-on-error: true

      # 步骤7：整理产物+留存日志
      - name: 步骤7/9 - 整理固件和日志
        run: |
          echo -e "\033[32m[开始] 整理固件产物和日志...\033[0m"
          mkdir -p ./固件输出目录
          if [ -d ./bin/targets/ramips/mt7620/ ]; then
            cp -rf ./bin/targets/ramips/mt7620/* ./固件输出目录/
            echo "[提示] 固件已复制到输出目录"
          else
            echo -e "\033[31m[错误] 未找到固件产物\033[0m"
            echo "产物缺失" > ./固件输出目录/产物缺失.log
          fi
          # 复制所有日志
          cp -f ./*.log ./固件输出目录/ 2>/dev/null
          cp -f ./*.flag ./固件输出目录/ 2>/dev/null
          # 生成产物清单
          ls -lh ./固件输出目录/ > ./固件输出目录/产物清单.log
          du -sh ./固件输出目录/ >> ./固件输出目录/产物清单.log
          echo -e "\033[32m[完成] 产物整理成功！\033[0m"
        timeout-minutes: 10
        continue-on-error: true

      # 步骤8：验证固件完整性
      - name: 步骤8/9 - 验证固件完整性
        run: |
          echo -e "\033[32m[开始] 验证固件完整性...\033[0m"
          if [ -f ./固件输出目录/*sysupgrade.bin ]; then
            md5sum ./固件输出目录/*sysupgrade.bin > ./固件输出目录/固件MD5值.log
            echo -e "\033[32m[完成] 固件验证成功！MD5值已保存\033[0m"
            cat ./固件输出目录/固件MD5值.log
          else
            echo -e "\033[31m[警告] 未找到sysupgrade刷入固件\033[0m"
            echo "无sysupgrade固件" > ./固件输出目录/固件缺失.log
          fi
        timeout-minutes: 5
        continue-on-error: true

      # 步骤9：上传固件和日志
      - name: 步骤9/9 - 上传固件和日志
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-MT7620A-SL-IR4-4线程固件+日志
          path: ./固件输出目录/
          retention-days: 14
          if-no-files-found: warn
        timeout-minutes: 10
