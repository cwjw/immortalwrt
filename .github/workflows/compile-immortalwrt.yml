# ImmortalWrt MT7620A(SL-IR4) äº‘ç¼–è¯‘è„šæœ¬-Ubuntu22.04ä¼˜åŒ–ç‰ˆ
# æ ¸å¿ƒç‰¹æ€§ï¼šå®æ—¶è¿›åº¦åé¦ˆ+4Gæ‹¨å·+WireGuard+ä¸­æ–‡LuCI+å·¥ä¸šæœºä¼˜åŒ–+é”™è¯¯å¿«é€Ÿå®šä½
name: Compile ImmortalWrt for MT7620A-SL-IR4 (Ubuntu22.04 | Real-time Log)

# è§¦å‘æ–¹å¼ï¼šæ‰‹åŠ¨è§¦å‘ï¼ˆé¦–é€‰ï¼‰/ä¿®æ”¹ä¸“å±é…ç½®è‡ªåŠ¨è§¦å‘
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'configs/ramips/mt7620/config-mt7620a-sl-ir4'

# ç¼–è¯‘ç¯å¢ƒï¼šUbuntu 22.04 LTSï¼ˆGitHub ActionsåŸç”Ÿæ”¯æŒï¼Œç¨³å®šå…¼å®¹ï¼‰
jobs:
  compile_firmware:
    runs-on: ubuntu-22.04
    timeout-minutes: 150 # å…¨å±€è¶…æ—¶ï¼Œè¶³å¤ŸMT7620Aå®Œæˆç¼–è¯‘ï¼ˆå«ä¾èµ–ä¸‹è½½ï¼‰
    defaults:
      run:
        shell: bash # ç»Ÿä¸€shellï¼Œé¿å…æ—¥å¿—è¾“å‡ºå¼‚å¸¸

    steps:
      # æ­¥éª¤1ï¼šå®‰è£…Ubuntu22.04ä¸“å±ç¼–è¯‘ä¾èµ–ï¼ˆé€‚é…æ–°ç‰ˆç³»ç»Ÿï¼Œè¡¥å……ç¼ºå¤±åº“ï¼‰
      - name: ğŸŸ¢ Step 1/6 - Install Compilation Dependencies (Ubuntu22.04)
        run: |
          echo -e "\033[32m[INFO] å¼€å§‹æ›´æ–°ç³»ç»Ÿæºå¹¶å®‰è£…ç¼–è¯‘ä¾èµ–...\033[0m"
          sudo apt update -y && sudo apt full-upgrade -y -q
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses5-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget \
          curl subversion libxml2 libxml2-utils xsltproc qemu-utils upx-ucl autoconf automake \
          libtool autopoint make libncursesw5-dev libelf-dev swig libpcre3-dev pkg-config patch \
          qemu-system-arm qemu-system-mips tree libssl3 libstdc++6
          # æ¸…ç†å†—ä½™åŒ…ï¼Œé‡Šæ”¾äº‘æœåŠ¡å™¨ç©ºé—´
          sudo apt autoremove -y && sudo apt clean -y && sudo rm -rf /var/lib/apt/lists/*
          echo -e "\033[32m[SUCCESS] ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆï¼\033[0m"
        timeout-minutes: 10 # ä¾èµ–å®‰è£…è¶…æ—¶é™åˆ¶ï¼Œé¿å…ç½‘ç»œå¡æ­»

      # æ­¥éª¤2ï¼šæ‹‰å–ImmortalWrtæºç ï¼ˆä¿®å¤Gitæ‰§è¡Œå¤±è´¥ï¼Œå…³é—­å­æ¨¡å—ï¼Œæ‹‰å–å®Œæ•´æºç ï¼‰
      - name: ğŸŸ¡ Step 2/6 - Pull ImmortalWrt Source Code (Fix Git Error)
        uses: actions/checkout@v4 # é€‚é…Ubuntu22.04çš„æœ€æ–°ç‰ˆæ‹‰å–å·¥å…·
        with:
          repository: ${{ github.repository }}
          ref: main
          fetch-depth: 0 # æ‹‰å–å®Œæ•´æºç ï¼Œé¿å…æ–‡ä»¶ç¼ºå¤±
          persist-credentials: false # å…³é—­å‡­è¯æŒä¹…åŒ–ï¼Œæå‡æ‹‰å–é€Ÿåº¦
        timeout-minutes: 10
        run: |
          echo -e "\033[33m[INFO] æºç æ‹‰å–å®Œæˆï¼Œå½“å‰ä»“åº“ç›®å½•ï¼š\033[0m"
          pwd && ls -lh

      # æ­¥éª¤3ï¼šåŠ è½½SL-IR4ä¸“å±é…ç½®æ–‡ä»¶ï¼ˆè‡ªåŠ¨è§£å†³ä¾èµ–ï¼Œå¯è§†åŒ–åŠ è½½æ—¥å¿—ï¼‰
      - name: ğŸ”µ Step 3/6 - Load SL-IR4 Custom Config & Resolve Dependencies
        run: |
          echo -e "\033[34m[INFO] å¼€å§‹åŠ è½½MT7620A-SL-IR4ä¸“å±é…ç½®æ–‡ä»¶...\033[0m"
          # å¤‡ä»½åŸæœ‰é…ç½®ï¼Œé¿å…å†²çª
          [ -f .config ] && { mv .config .config.bak; echo -e "\033[34m[INFO] å·²å¤‡ä»½åŸæœ‰.configæ–‡ä»¶ä¸º.config.bak\033[0m"; }
          # å¤åˆ¶ä¸“å±é…ç½®ä¸ºç¼–è¯‘é»˜è®¤é…ç½®
          cp configs/ramips/mt7620/config-mt7620a-sl-ir4 .config
          echo -e "\033[34m[INFO] å¼€å§‹è‡ªåŠ¨è§£æé…ç½®ä¾èµ–ï¼Œç”Ÿæˆæœ€ç»ˆç¼–è¯‘é…ç½®...\033[0m"
          make defconfig V=s # è¯¦ç»†è¾“å‡ºä¾èµ–è§£ææ—¥å¿—ï¼Œå®æ—¶åé¦ˆ
          echo -e "\033[32m[SUCCESS] ä¸“å±é…ç½®åŠ è½½å®Œæˆï¼Œä¾èµ–è§£ææˆåŠŸï¼\033[0m"
        timeout-minutes: 6

      # æ­¥éª¤4ï¼šä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…+æ ¸å¿ƒç¼–è¯‘å›ºä»¶ï¼ˆå•çº¿ç¨‹ï¼Œå®æ—¶è¾“å‡ºç¼–è¯‘è¿›åº¦ï¼‰
      - name: ğŸ”´ Step 4/6 - Download Dependencies & Compile Firmware (Real-time Log)
        run: |
          echo -e "\033[31m[INFO] å¼€å§‹å•çº¿ç¨‹ä¸‹è½½ç¼–è¯‘ä¾èµ–åŒ…ï¼ˆå®æ—¶æ˜¾ç¤ºä¸‹è½½è¿›åº¦ï¼‰...\033[0m"
          make -j1 download V=s # å•çº¿ç¨‹ä¸‹è½½ï¼Œé¿å…ç½‘ç»œè¶…æ—¶ï¼Œæ—¥å¿—å®æ—¶è¾“å‡º
          echo -e "\033[31m[SUCCESS] æ‰€æœ‰ç¼–è¯‘ä¾èµ–åŒ…ä¸‹è½½å®Œæˆï¼\033[0m"
          echo -e "\033[31m[INFO] å¼€å§‹å•çº¿ç¨‹ç¼–è¯‘å›ºä»¶ï¼ˆMT7620Aï¼Œå®æ—¶æ˜¾ç¤ºç¼–è¯‘è¿›åº¦ï¼Œçº¦30-60åˆ†é’Ÿï¼‰...\033[0m"
          make -j1 V=s # æ ¸å¿ƒç¼–è¯‘ï¼Œæ— æ—¥å¿—é‡å®šå‘ï¼Œé€è¡Œå®æ—¶æ‰“å°ç¼–è¯‘è¿›åº¦
          echo -e "\033[32m[SUCCESS] å›ºä»¶ç¼–è¯‘å®Œæˆï¼\033[0m"
        timeout-minutes: 120 # æ ¸å¿ƒç¼–è¯‘è¶…æ—¶ï¼Œè¶³å¤ŸMT7620Aå®Œæˆç¼–è¯‘

      # æ­¥éª¤5ï¼šæ•´ç†ç¼–è¯‘äº§ç‰©+æ ¡éªŒæ–‡ä»¶ï¼ˆå®æ—¶æ‰“å°äº§ç‰©ä¿¡æ¯ï¼Œç•™å­˜ç¼–è¯‘æ—¥å¿—ï¼‰
      - name: ğŸŸ¢ Step 5/6 - Organize Firmware & Check Files
        run: |
          echo -e "\033[32m[INFO] å¼€å§‹æ•´ç†ç¼–è¯‘äº§ç‰©ï¼Œåˆ›å»ºè¾“å‡ºç›®å½•...\033[0m"
          mkdir -p ./firmware-output
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶äº§ç‰©ï¼ˆå«sysupgrade.binåˆ·å…¥æ–‡ä»¶ã€å†…æ ¸é•œåƒç­‰ï¼‰
          cp -rf ./bin/targets/ramips/mt7620/* ./firmware-output/
          # ç•™å­˜å®Œæ•´ç¼–è¯‘æ—¥å¿—ï¼Œæ–¹ä¾¿æ’é”™
          dmesg > ./firmware-output/dmesg.log
          [ -f compile.log ] && cp compile.log ./firmware-output/
          echo -e "\033[32m[INFO] ç¼–è¯‘äº§ç‰©æ•´ç†å®Œæˆï¼Œæ–‡ä»¶åˆ—è¡¨&å¤§å°å¦‚ä¸‹ï¼š\033[0m"
          ls -lh ./firmware-output/ # å®æ—¶æ‰“å°äº§ç‰©ä¿¡æ¯ï¼Œç¡®è®¤åˆ·å…¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          du -sh ./firmware-output/ # æ‰“å°äº§ç‰©æ€»å¤§å°
          echo -e "\033[32m[SUCCESS] äº§ç‰©æ•´ç†&æ ¡éªŒå®Œæˆï¼\033[0m"
        timeout-minutes: 8

      # æ­¥éª¤6ï¼šä¸Šä¼ å›ºä»¶åˆ°GitHub Artifactsï¼ˆç›´æ¥ä¸‹è½½ï¼Œä¿ç•™7å¤©ï¼‰
      - name: ğŸŸ¡ Step 6/6 - Upload Firmware to GitHub Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ImmortalWrt-MT7620A-SL-IR4-Firmware (Ubuntu22.04)
          path: ./firmware-output/
          retention-days: 7 # å›ºä»¶ä¿ç•™7å¤©ï¼Œå¯ä¿®æ”¹ä¸º1-90ï¼ˆæœ€å¤§90å¤©ï¼‰
          if-no-files-found: error # æ— äº§ç‰©æ—¶ç›´æ¥æ ‡è®°å¤±è´¥ï¼Œé¿å…ç©ºåŒ…
        timeout-minutes: 10
